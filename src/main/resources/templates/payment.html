<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Pembayaran - Blue Swan Coffee</title>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4a6fa5',
                        bg: '#d9c6b0',
                        'primary-dark': '#355a8c',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Animations & Shapes */
        .blob {
            position: absolute;
            filter: blur(40px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .nav-link {
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #4a6fa5;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        /* Item Scrollbar */
        .item-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .item-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .item-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
    </style>
</head>

<body
    class="bg-bg text-[#1a1a1a] font-sans selection:bg-primary selection:text-white min-h-screen flex flex-col relative overflow-x-hidden">

    <!-- Background Elements -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-[-1]">
        <div class="blob bg-primary w-[500px] h-[500px] rounded-full top-[-10%] right-[-10%] opacity-20"></div>
        <div
            class="blob bg-white w-[300px] h-[300px] rounded-full bottom-[10%] left-[-5%] opacity-30 animation-delay-2000">
        </div>
    </div>

    <!-- Floating Navbar -->
    <div class="fixed w-full z-50 px-4 mt-6">
        <nav class="max-w-7xl mx-auto glass-nav rounded-2xl flex justify-between items-center px-8 py-4">
            <a th:href="@{/}" class="text-2xl font-bold text-primary italic tracking-tight">Blue Swan <span
                    class="text-[#1a1a1a]">Coffee.</span></a>

            <div class="hidden lg:flex items-center gap-8">
                <a th:href="@{/}"
                    class="nav-link text-[#1a1a1a] font-medium hover:text-primary transition-colors">Home</a>
                <a href="/#about"
                    class="nav-link text-[#1a1a1a] font-medium hover:text-primary transition-colors">About</a>
                <a th:href="@{/menu}"
                    class="nav-link text-[#1a1a1a] font-medium hover:text-primary transition-colors">Menu</a>
                <a href="/#contact"
                    class="nav-link text-[#1a1a1a] font-medium hover:text-primary transition-colors">Contact</a>
            </div>

            <div class="flex items-center gap-4">
                <a th:href="@{/cart}" class="p-2 rounded-full hover:bg-white/50 transition-all text-primary relative">
                    <i data-feather="shopping-cart" class="w-5 h-5"></i>
                </a>

                <a th:href="@{/profile}"
                    class="p-2 rounded-full bg-primary/10 text-primary hover:bg-primary hover:text-white transition-all shadow-sm relative"
                    title="Profil Saya">
                    <i data-feather="user" class="w-5 h-5"></i>
                    <span th:if="${hasUnpaidOrder}"
                        class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
                </a>

                <a th:href="@{/logout}"
                    class="hidden lg:inline-block px-6 py-2 border-2 border-red-500 text-red-500 rounded-full font-semibold hover:bg-red-500 hover:text-white transition-all">Logout</a>

                <button id="hamburger-menu" class="lg:hidden p-2 text-[#1a1a1a]"><i data-feather="menu"></i></button>
            </div>
        </nav>
    </div>

    <!-- Main Payment Content -->
    <main class="flex-grow flex items-center justify-center pt-32 pb-20 px-4">
        <div class="max-w-4xl w-full grid lg:grid-cols-2 gap-8 items-stretch">

            <!-- Summary Card -->
            <div class="glass-card rounded-3xl p-8 flex flex-col justify-between max-h-[700px]">
                <div>
                    <h2 class="text-3xl font-bold text-[#1a1a1a] mb-2">Order Summary</h2>
                    <p class="text-gray-600 mb-6">Complete your payment to enjoy your coffee.</p>

                    <div class="space-y-4">

                        <div class="flex justify-between items-center py-3 border-b border-gray-300/50">
                            <span class="text-gray-600">Order ID</span>
                            <span class="font-mono text-sm font-bold text-primary"
                                th:text="${'#' + (order.id != null ? #strings.substring(order.id.toString(),0,8) : '???')}">#ORD-123456</span>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-300/50">
                            <span class="text-gray-600">Date</span>
                            <span class="font-medium"
                                th:text="${#temporals.format(order.createdAt, 'dd MMM yyyy HH:mm')}">Oct 29, 2023</span>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-300/50">
                            <span class="text-gray-600">Status</span>
                            <span th:if="${order.status.name() == 'CREATED'}"
                                class="badge bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold text-sm">WAITING
                                FOR PAYMENT</span>
                            <span th:if="${order.status.name() == 'PAID'}"
                                class="badge bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold text-sm">PAID</span>
                            <span th:if="${order.status.name() == 'CANCELED'}"
                                class="badge bg-red-100 text-red-800 px-3 py-1 rounded-full font-bold text-sm">CANCELED</span>
                        </div>

                        <!-- ITEM LIST SUMMARY -->
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-500 text-xs uppercase tracking-wider mb-2">Items</h4>
                            <div class="item-scroll max-h-[150px] overflow-y-auto pr-2 space-y-2">
                                <div th:each="item : ${order.items}"
                                    class="flex justify-between items-center text-sm p-3 bg-white/40 rounded-xl">
                                    <div>
                                        <span class="font-bold block text-[#1a1a1a]"
                                            th:text="${item.product.name}">Cappuccino</span>
                                        <span class="text-xs text-gray-500"
                                            th:text="${item.quantity + ' x ' + item.product.price}">2 x 25000</span>
                                    </div>
                                    <span class="font-bold text-primary" th:text="${item.subtotal}">50000</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/30 rounded-2xl p-6 mt-6">
                            <span class="block text-gray-500 text-sm mb-1">Total Amount</span>
                            <span class="block text-4xl font-bold text-primary tracking-tight">
                                IDR <span th:text="${order.totalAmount}">55.000</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <a href="/profile"
                        class="flex items-center gap-2 text-gray-600 hover:text-red-500 transition-colors">
                        <i data-feather="arrow-left" class="w-4 h-4"></i> Back to Orders
                    </a>
                </div>
            </div>

            <!-- Payment Action Card -->
            <div
                class="bg-white/80 backdrop-blur-md rounded-3xl p-8 shadow-2xl flex flex-col items-center text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-blue-300"></div>

                <!-- CONDITION: CREATED (Show QR & Timer) -->
                <div th:if="${order.status.name() == 'CREATED'}" class="w-full h-full flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-6">Scan QRIS to Pay</h3>

                    <div class="w-64 h-64 bg-white p-2 rounded-xl shadow-inner mb-6 relative group">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/QR_code_for_mobile_English_Wikipedia.svg/1200px-QR_code_for_mobile_English_Wikipedia.svg.png"
                            class="w-full h-full object-contain mix-blend-multiply opacity-90 group-hover:opacity-100 transition-opacity"
                            alt="QR Code" />
                        <!-- Scan line animation -->
                        <div
                            class="absolute top-0 left-0 w-full h-1 bg-red-500 opacity-50 shadow-[0_0_10px_red] animate-[scan_2s_linear_infinite]">
                        </div>
                    </div>

                    <style>
                        @keyframes scan {
                            0% {
                                top: 0%;
                            }

                            50% {
                                top: 100%;
                            }

                            100% {
                                top: 0%;
                            }
                        }
                    </style>

                    <div class="mb-4 w-full">
                        <p class="text-sm text-gray-500 mb-1">Payment Expires In:</p>
                        <div id="countdown"
                            class="text-3xl font-mono font-bold text-red-500 bg-red-50 py-2 rounded-lg border border-red-100">
                            Loading...
                        </div>
                    </div>

                    <form th:action="@{/payment/process}" method="post" class="w-full mt-auto">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="orderId" th:value="${order.id}">
                        <button type="submit"
                            class="w-full py-4 bg-primary text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-primary-dark transition-all transform hover:-translate-y-1 flex items-center justify-center gap-2">
                            <i data-feather="check-circle" class="w-5 h-5"></i> I HAVE PAID
                        </button>
                    </form>
                </div>

                <!-- CONDITION: PAID (Success) -->
                <div th:if="${order.status.name() == 'PAID'}"
                    class="w-full h-full flex flex-col items-center justify-center animate-in fade-in zoom-in duration-500">
                    <div
                        class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-500 shadow-lg">
                        <i data-feather="check" class="w-12 h-12"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-[#1a1a1a] mb-2">Payment Successful!</h3>
                    <p class="text-gray-600 mb-8">Thank you, your order is being processed.</p>
                    <a href="/menu"
                        class="px-8 py-3 bg-primary text-white font-bold rounded-xl shadow-md hover:bg-primary-dark transition-colors">
                        Order Again
                    </a>
                </div>

                <!-- CONDITION: CANCELED (Failed/Expired) -->
                <div th:if="${order.status.name() == 'CANCELED'}"
                    class="w-full h-full flex flex-col items-center justify-center animate-in fade-in zoom-in duration-500">
                    <div
                        class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 text-red-500 shadow-lg">
                        <i data-feather="x" class="w-12 h-12"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-[#1a1a1a] mb-2">Payment Failed</h3>
                    <p class="text-gray-600 mb-8">Sorry, this order has been canceled or the payment time has expired.
                    </p>
                    <a href="/menu"
                        class="px-8 py-3 bg-[#1a1a1a] text-white font-bold rounded-xl shadow-md hover:bg-gray-800 transition-colors">
                        Back to Menu
                    </a>
                </div>

            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        feather.replace();
    </script>

    <script th:if="${order.status.name() == 'CREATED'}" th:inline="javascript">
        /*<![CDATA[*/
        // Get deadline from backend (Epoch Millis)
        const deadlineMillis = /*[[${deadline}]]*/ 0;

        function updateTimer() {
            const now = new Date().getTime();
            const distance = deadlineMillis - now;

            if (distance < 0) {
                document.getElementById("countdown").innerHTML = "EXPIRED";
                document.getElementById("countdown").classList.remove("text-red-500", "bg-red-50");
                document.getElementById("countdown").classList.add("bg-gray-200", "text-gray-500");

                // Auto-refresh to trigger backend status update to CANCELED
                setTimeout(() => window.location.reload(), 2000);

                clearInterval(timerInterval);
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Pad with zero
            const mStr = minutes < 10 ? "0" + minutes : minutes;
            const sStr = seconds < 10 ? "0" + seconds : seconds;

            document.getElementById("countdown").innerHTML = `${mStr}:${sStr}`;
        }

        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // run immediately
        /*]]>*/
    </script>
</body>

</html>